<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Integra√ß√£o OSM com Sistema de Avalia√ß√µes</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        button.warning {
            background-color: #ff9800;
        }
        button.warning:hover {
            background-color: #e68900;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
        }
        .card.restaurant { border-left-color: #FF5722; }
        .card.bar { border-left-color: #9C27B0; }
        .card.cafe { border-left-color: #FF9800; }
        .card.fast_food { border-left-color: #2196F3; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
            max-height: 300px;
        }
        .restaurant-detail {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .coords {
            font-family: monospace;
            background: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Teste da Integra√ß√£o OSM ‚Üí Sistema de Avalia√ß√µes</h1>
        
        <div class="section">
            <h2>üìä Status da Importa√ß√£o</h2>
            <p>Verificar quantos estabelecimentos OSM foram importados para o sistema principal.</p>
            <button onclick="checkImportStatus()">Verificar Status</button>
            <button onclick="checkMainRestaurants()">Ver Restaurantes Principais</button>
            <div id="statusResult"></div>
        </div>

        <div class="section">
            <h2>üîÑ A√ß√µes de Importa√ß√£o</h2>
            <div class="grid">
                <div class="card">
                    <h3>Importa√ß√£o R√°pida</h3>
                    <p>Importar apenas restaurantes (28 estabelecimentos)</p>
                    <button onclick="quickImport()">Importar Restaurantes</button>
                </div>
                
                <div class="card">
                    <h3>Importa√ß√£o Completa</h3>
                    <p>Importar todos os tipos (52 estabelecimentos)</p>
                    <button onclick="fullImport()">Importar Todos</button>
                </div>
                
                <div class="card">
                    <h3>Sincroniza√ß√£o</h3>
                    <p>Atualizar existentes + importar novos</p>
                    <button class="warning" onclick="syncImport()">Sincronizar</button>
                </div>
                
                <div class="card">
                    <h3>Reimporta√ß√£o</h3>
                    <p>Substituir todos os estabelecimentos OSM</p>
                    <button class="danger" onclick="reimport()">Reimportar</button>
                </div>
            </div>
            <div id="importResult"></div>
        </div>

        <div class="section">
            <h2>üçΩÔ∏è Restaurantes Importados</h2>
            <p>Visualizar estabelecimentos que foram importados do OSM para o sistema principal.</p>
            <button onclick="loadImportedRestaurants()">Carregar Restaurantes</button>
            <button onclick="loadRestaurantsByType('restaurant')">Apenas Restaurantes</button>
            <button onclick="loadRestaurantsByType('bar')">Apenas Bares</button>
            <button onclick="loadRestaurantsByType('cafe')">Apenas Caf√©s</button>
            <button onclick="loadRestaurantsByType('fast_food')">Apenas Lanchonetes</button>
            <div id="restaurantsResult"></div>
        </div>

        <div class="section">
            <h2>üîç Detalhes de Restaurante</h2>
            <p>Testar visualiza√ß√£o de detalhes de um restaurante espec√≠fico.</p>
            <input type="number" id="restaurantId" placeholder="ID do restaurante" value="6">
            <button onclick="loadRestaurantDetails()">Ver Detalhes</button>
            <div id="detailsResult"></div>
        </div>

        <div class="section">
            <h2>‚≠ê Simula√ß√£o de Avalia√ß√£o</h2>
            <p>Testar se os restaurantes importados podem receber avalia√ß√µes (simula√ß√£o).</p>
            <div>
                <input type="number" id="reviewRestaurantId" placeholder="ID do restaurante" value="6">
                <select id="reviewRating">
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 estrelas)</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4 estrelas)</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê (3 estrelas)</option>
                    <option value="2">‚≠ê‚≠ê (2 estrelas)</option>
                    <option value="1">‚≠ê (1 estrela)</option>
                </select>
                <input type="text" id="reviewComment" placeholder="Coment√°rio da avalia√ß√£o" value="√ìtimo estabelecimento importado do OSM!">
                <button onclick="simulateReview()">Simular Avalia√ß√£o</button>
            </div>
            <div id="reviewResult"></div>
        </div>

        <div class="section">
            <h2>üóëÔ∏è Limpeza</h2>
            <p style="color: #d32f2f;">‚ö†Ô∏è Cuidado: Esta a√ß√£o remove TODOS os estabelecimentos OSM importados!</p>
            <button class="danger" onclick="removeOSMRestaurants()">Remover Estabelecimentos OSM</button>
            <div id="cleanupResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';

        // Fun√ß√£o para fazer requisi√ß√µes HTTP
        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        // Fun√ß√£o para exibir resultados
        function displayResult(elementId, result, type = 'general') {
            const element = document.getElementById(elementId);
            
            if (!result.success) {
                element.innerHTML = `
                    <div class="status error">
                        <strong>Erro:</strong> ${result.error || result.data?.message || 'Erro desconhecido'}
                    </div>
                `;
                return;
            }

            if (type === 'status') {
                const data = result.data.data;
                element.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${data.osm_available}</div>
                            <div class="stat-label">OSM Dispon√≠veis</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.total_restaurants}</div>
                            <div class="stat-label">Total Restaurantes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.osm_imported}</div>
                            <div class="stat-label">OSM Importados</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${data.import_percentage}%</div>
                            <div class="stat-label">Importa√ß√£o Completa</div>
                        </div>
                    </div>
                    <div class="status success">
                        <h4>Estat√≠sticas por Tipo:</h4>
                        <ul>
                            ${data.import_stats_by_type.map(item => `<li><strong>${item.tipo}:</strong> ${item.quantidade}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else if (type === 'restaurants') {
                const restaurants = result.data.restaurants || result.data.data || result.data;
                const pagination = result.data.pagination;

                if (!restaurants || restaurants.length === 0) {
                    element.innerHTML = `
                        <div class="status warning">
                            <strong>Nenhum restaurante encontrado.</strong>
                        </div>
                    `;
                    return;
                }

                let html = '';
                
                if (pagination) {
                    html += `
                        <div class="status info">
                            <strong>P√°gina:</strong> ${pagination.current} de ${pagination.pages} | 
                            <strong>Total:</strong> ${pagination.total} restaurantes
                        </div>
                    `;
                }

                html += `
                    <div class="grid">
                        ${restaurants.map(r => {
                            const tipo = r.description?.includes('Tipo: Restaurante') ? 'restaurant' :
                                        r.description?.includes('Tipo: Bar') ? 'bar' :
                                        r.description?.includes('Tipo: Caf√©') ? 'cafe' :
                                        r.description?.includes('Tipo: Lanchonete') ? 'fast_food' : 'restaurant';
                            
                            return `
                                <div class="card ${tipo}">
                                    <h4>${r.name}</h4>
                                    <p><strong>ID:</strong> ${r.id}</p>
                                    <p><strong>Endere√ßo:</strong> ${r.address}</p>
                                    <p><strong>Posts:</strong> ${r.posts_count || 0} | <strong>Favoritos:</strong> ${r.favorites_count || 0}</p>
                                    <p><strong>Avalia√ß√£o:</strong> ${r.average_rating ? r.average_rating.toFixed(1) : 'Sem avalia√ß√µes'} ‚≠ê</p>
                                    <button onclick="loadRestaurantDetails(${r.id})">Ver Detalhes</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                element.innerHTML = html;
            } else if (type === 'detail') {
                const restaurant = result.data.restaurant;
                element.innerHTML = `
                    <div class="restaurant-detail">
                        <h3>${restaurant.name}</h3>
                        <p><strong>ID:</strong> ${restaurant.id}</p>
                        <p><strong>Endere√ßo:</strong> ${restaurant.address}</p>
                        <p><strong>Criado em:</strong> ${new Date(restaurant.created_at).toLocaleString()}</p>
                        <p><strong>Posts:</strong> ${restaurant.posts_count} | <strong>Favoritos:</strong> ${restaurant.favorites_count}</p>
                        <p><strong>Avalia√ß√£o M√©dia:</strong> ${restaurant.average_rating || 'Sem avalia√ß√µes'}</p>
                        <h4>Descri√ß√£o:</h4>
                        <pre>${restaurant.description}</pre>
                    </div>
                `;
            } else {
                element.innerHTML = `
                    <div class="status success">
                        <strong>Opera√ß√£o conclu√≠da com sucesso!</strong>
                        <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    </div>
                `;
            }
        }

        // 1. Verificar status da importa√ß√£o
        async function checkImportStatus() {
            const result = await makeRequest(`${API_BASE}/osm-estabelecimentos/import/status`);
            displayResult('statusResult', result, 'status');
        }

        // 2. Verificar restaurantes principais
        async function checkMainRestaurants() {
            const result = await makeRequest(`${API_BASE}/restaurants?limit=10`);
            displayResult('statusResult', result, 'restaurants');
        }

        // 3. Importa√ß√£o r√°pida
        async function quickImport() {
            const result = await makeRequest(`${API_BASE}/osm-estabelecimentos/import/quick`, {
                method: 'POST'
            });
            displayResult('importResult', result);
            // Atualizar status ap√≥s importa√ß√£o
            setTimeout(checkImportStatus, 1000);
        }

        // 4. Importa√ß√£o completa
        async function fullImport() {
            const result = await makeRequest(`${API_BASE}/osm-estabelecimentos/import/full`, {
                method: 'POST'
            });
            displayResult('importResult', result);
            setTimeout(checkImportStatus, 1000);
        }

        // 5. Sincroniza√ß√£o
        async function syncImport() {
            const result = await makeRequest(`${API_BASE}/osm-estabelecimentos/import/sync`, {
                method: 'POST'
            });
            displayResult('importResult', result);
            setTimeout(checkImportStatus, 1000);
        }

        // 6. Reimporta√ß√£o
        async function reimport() {
            if (!confirm('Tem certeza? Isso ir√° substituir todos os estabelecimentos OSM existentes!')) {
                return;
            }
            
            const result = await makeRequest(`${API_BASE}/osm-estabelecimentos/import/reimport`, {
                method: 'POST',
                body: JSON.stringify({ confirm: true })
            });
            displayResult('importResult', result);
            setTimeout(checkImportStatus, 1000);
        }

        // 7. Carregar restaurantes importados
        async function loadImportedRestaurants() {
            const result = await makeRequest(`${API_BASE}/restaurants?limit=20`);
            displayResult('restaurantsResult', result, 'restaurants');
        }

        // 8. Carregar por tipo
        async function loadRestaurantsByType(type) {
            // Como n√£o temos filtro direto por tipo, vamos buscar todos e filtrar
            const result = await makeRequest(`${API_BASE}/restaurants?limit=100`);
            if (result.success) {
                const typeMap = {
                    'restaurant': 'Restaurante',
                    'bar': 'Bar',
                    'cafe': 'Caf√©',
                    'fast_food': 'Lanchonete'
                };
                
                const filtered = result.data.restaurants.filter(r => 
                    r.description?.includes(`Tipo: ${typeMap[type]}`)
                );
                
                result.data.restaurants = filtered;
                result.data.pagination.total = filtered.length;
            }
            displayResult('restaurantsResult', result, 'restaurants');
        }

        // 9. Carregar detalhes de restaurante
        async function loadRestaurantDetails(id = null) {
            const restaurantId = id || document.getElementById('restaurantId').value;
            if (!restaurantId) {
                alert('Por favor, informe o ID do restaurante');
                return;
            }
            
            const result = await makeRequest(`${API_BASE}/restaurants/${restaurantId}`);
            displayResult('detailsResult', result, 'detail');
        }

        // 10. Simular avalia√ß√£o
        async function simulateReview() {
            const restaurantId = document.getElementById('reviewRestaurantId').value;
            const rating = document.getElementById('reviewRating').value;
            const comment = document.getElementById('reviewComment').value;

            if (!restaurantId || !rating || !comment) {
                alert('Por favor, preencha todos os campos');
                return;
            }

            // Simula√ß√£o - criar um post de avalia√ß√£o
            const postData = {
                restaurant_id: parseInt(restaurantId),
                title: `Avalia√ß√£o ${rating} estrelas`,
                content: comment,
                rating: parseInt(rating)
            };

            const result = await makeRequest(`${API_BASE}/posts`, {
                method: 'POST',
                body: JSON.stringify(postData)
            });

            if (result.success) {
                document.getElementById('reviewResult').innerHTML = `
                    <div class="status success">
                        <strong>Avalia√ß√£o simulada criada!</strong>
                        <p>Post ID: ${result.data.id}</p>
                        <p>Rating: ${rating} estrelas</p>
                        <p>Coment√°rio: ${comment}</p>
                    </div>
                `;
            } else {
                displayResult('reviewResult', result);
            }
        }

        // 11. Remover estabelecimentos OSM
        async function removeOSMRestaurants() {
            if (!confirm('ATEN√á√ÉO: Isso ir√° remover TODOS os estabelecimentos importados do OSM! Continuar?')) {
                return;
            }
            
            const result = await makeRequest(`${API_BASE}/osm-estabelecimentos/import`, {
                method: 'DELETE',
                body: JSON.stringify({ confirm: true })
            });
            displayResult('cleanupResult', result);
            setTimeout(checkImportStatus, 1000);
        }

        // Verificar status automaticamente ao carregar a p√°gina
        window.onload = function() {
            checkImportStatus();
        };
    </script>
</body>
</html>


